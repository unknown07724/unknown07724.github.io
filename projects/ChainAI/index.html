<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CBPT Markov AI Chat</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
button, input, select { margin: 5px; padding: 10px; font-size: 16px; }
#messageList { margin-top: 20px; list-style: none; max-height: 400px; overflow-y: auto; padding: 0; display:flex; flex-direction:column; }
.message-item { margin: 5px 0; padding: 10px; border-radius:8px; max-width:60%; }
.user-message { align-self:flex-start; background:#d1e7dd; text-align:left; }
.ai-message { align-self:flex-end; background:#f8d7da; text-align:right; }
.settings-button { position: fixed; bottom: 20px; right: 20px; background-color: #007BFF; color: white; border: none; padding: 15px; border-radius: 50%; font-size: 20px; cursor: pointer; }
.settings-button:hover { background-color: #0056b3; }
.settings-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
.settings-content { background: white; padding: 20px; border-radius: 10px; text-align: left; width: 500px; position: relative; max-height: 90%; overflow-y: auto; }
.close-button { position: absolute; top:10px; right:15px; background:red; color:white; border:none; padding:5px 10px; cursor:pointer; font-size:14px; }
.close-button:hover { background: darkred; }
#modelDescription { font-size: 14px; color: #333; margin-top: 5px; margin-bottom:10px; }
.word-list { margin-top: 10px; }
.word-item { margin: 5px 0; padding: 5px; border: 1px solid #aaa; display:flex; justify-content:space-between; align-items:center; }
.word-item button { margin-left:5px; }
.training-section { display:none; margin-top:10px; border:1px solid red; padding:10px; border-radius:5px; background:#ffe5e5; }
</style>
</head>
<body>

<h1>CBPT Markov AI Chat</h1>

<h2>Messages</h2>
<ul id="messageList"></ul>

<h2>Send a Message</h2>
<input type="text" id="user-message" placeholder="Type a message" style="width:70%;">
<button onclick="sendMessage()">Send</button>

<button class="settings-button" onclick="toggleSettings()">⚙️</button>

<!-- Settings / Training Modal -->
<div id="settingsModal" class="settings-modal">
    <div class="settings-content">
        <button class="close-button" onclick="toggleSettings()">✖</button>
        <h2>Settings - Select Model</h2>
        <label for="modelSelect">Select Model:</label>
        <select id="modelSelect" onchange="updateModelDescription()"></select>
        <div id="modelDescription"></div>

        <hr>
        <button onclick="revealTraining()">⚠️ Warning: Do not mess with training unless you know what you are doing ⚠️</button>

        <div id="trainingSection" class="training-section">
            <h3>CBPT-2 Word Manager</h3>
            <button onclick="showMakeWordForm()">Make New Word</button>
            <div id="wordList" class="word-list"></div>

            <div id="makeWordForm" style="margin-top:10px; display:none;">
                <input type="text" id="wordInput" placeholder="Word">
                <input type="text" id="posInput" placeholder="Part of speech">
                <input type="text" id="transitionsInput" placeholder="Transitions (word:prob,word:prob)">
                <button onclick="saveWord()">Save</button>
                <button id="deleteWordBtn" onclick="deleteWord()" style="display:none; background:red; color:white;">Delete</button>
                <button onclick="cancelWordForm()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== Models JSON =====
let models = {
    "CBPT-1": { ngrams: 0, english: null, description:"English only, JSON-based, old-school responses" },
    "CBPT-2": { ngrams: 3, js:null, python:null, html:null, rust:null, english:null, description:"Dynamic n-grams, multiple languages, uses CBPT-1 JSON" },
    "CBPT-test-1":  { 
        ngrams: 10, js:null, python:null, html:null, rust:null, 
        english: [
            "The United States of America (USA), also known as the United States (U.S.) or America, is a country primarily located in North America. It is a federal republic of 50 states and a federal capital district, Washington, D.C. The 48 contiguous states border Canada to the north and Mexico to the south, with the semi-exclave of Alaska in the northwest and the archipelago of Hawaii in the Pacific Ocean. The United States also asserts sovereignty over five major island territories and various uninhabited islands in Oceania and the Caribbean. It is a megadiverse country, with the world's third-largest land area and third-largest population, exceeding 340 million.",
            "America is a federal republic composed of fifty states. The country stretches from the Atlantic Ocean to the Pacific, with diverse geography and climates. Its government is a democracy with a president and Congress, and it is one of the world's most influential nations."
        ],
        description:"Test model with multiple corpora and decagrams" 
    }
};

let selectedModel = "CBPT-1";
let cbptJSON = {}; // CBPT-1 JSON
let userMessages = [];
let generatedMessages = [];

// ===== Load CBPT-1 JSON if any model needs it =====
async function loadCBPTJSON() {
    const needsJSON = Object.values(models).some(m => m.english === null);
    if(!needsJSON) return;

    try {
        const res = await fetch('words.json');
        cbptJSON = await res.json();
        console.log("CBPT-1 JSON loaded");

        // initialize CBPT-2 from CBPT-1 JSON
        models["CBPT-2"].js = JSON.parse(JSON.stringify(cbptJSON));
    } catch(e) {
        console.error("Failed to load words.json:", e);
    }
}

// ===== Populate model selector dynamically =====
function populateModelSelector() {
    const select = document.getElementById("modelSelect");
    select.innerHTML = "";
    for (let key in models) {
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        select.appendChild(opt);
    }
    updateModelDescription();
}

// ===== Update model description =====
function updateModelDescription() {
    selectedModel = document.getElementById("modelSelect").value;
    document.getElementById("modelDescription").textContent = models[selectedModel].description;
}

// ===== Training Section =====
let editingWord = null;

function revealTraining() {
    document.getElementById("trainingSection").style.display="block";
    renderWordList();
}

function renderWordList(){
    const listDiv = document.getElementById("wordList");
    listDiv.innerHTML="";
    if(selectedModel !== "CBPT-2") return;

    for(const word in models["CBPT-2"].js){
        const div = document.createElement("div");
        div.className="word-item";
        div.textContent = word;

        const editBtn = document.createElement("button");
        editBtn.textContent="Edit";
        editBtn.onclick = () => showEditWordForm(word);

        div.appendChild(editBtn);
        listDiv.appendChild(div);
    }
}

function showMakeWordForm(){
    editingWord = null;
    document.getElementById("makeWordForm").style.display = "block";
    document.getElementById("wordInput").value = "";
    document.getElementById("posInput").value = "";
    document.getElementById("transitionsInput").value = "";
    document.getElementById("deleteWordBtn").style.display = "none";
}

function showEditWordForm(word){
    editingWord = word;
    const wordObj = models["CBPT-2"].js[word];
    document.getElementById("makeWordForm").style.display = "block";
    document.getElementById("wordInput").value = word;
    document.getElementById("posInput").value = wordObj.part_of_speech || "";
    const transitionsArr = [];
    for(const t in wordObj.transitions) transitionsArr.push(`${t}:${wordObj.transitions[t]}`);
    document.getElementById("transitionsInput").value = transitionsArr.join(",");
    document.getElementById("deleteWordBtn").style.display = "inline-block";
}

function cancelWordForm(){ document.getElementById("makeWordForm").style.display="none"; }

function saveWord(){
    const word = document.getElementById("wordInput").value.trim();
    const pos = document.getElementById("posInput").value.trim();
    const transitionsInput = document.getElementById("transitionsInput").value.trim();
    if(!word || !pos){ alert("Word and POS required"); return; }

    const transitions = {};
    transitionsInput.split(",").forEach(pair => {
        const [key,val] = pair.split(":");
        if(key && val) transitions[key.trim()] = parseFloat(val);
    });

    models["CBPT-2"].js[word] = { part_of_speech: pos, valid_next: [], transitions };
    cancelWordForm();
    renderWordList();
}

function deleteWord(){
    if(editingWord && confirm("Are you sure you want to delete "+editingWord+"?")){
        delete models["CBPT-2"].js[editingWord];
        editingWord = null;
        cancelWordForm();
        renderWordList();
    }
}

// ===== N-gram functions =====
function buildNgramsFromJSON(json, n=3){
    const tokens = Object.keys(json);
    const ngrams = {};
    for(let i=0;i<=tokens.length-n;i++){
        const key = tokens.slice(i,i+n).join(" ");
        const next = tokens[i+n];
        if(!ngrams[key]) ngrams[key] = [];
        if(next) ngrams[key].push(next);
    }
    return ngrams;
}

function buildNgramsFromString(text, n=3){
    const tokens = text.match(/\b[\w'()-]+\b|[.,!?;]/g) || [];
    const ngrams = {};
    for(let i=0;i<=tokens.length-n;i++){
        const key = tokens.slice(i,i+n).join(" ");
        const next = tokens[i+n];
        if(!ngrams[key]) ngrams[key] = [];
        if(next) ngrams[key].push(next);
    }
    return ngrams;
}

// ===== Message Generation =====
function generateCBPT1(start="", maxWords=15){
    let word = start.split(" ").slice(-1)[0];
    let sentence = [word];
    for(let i=0;i<maxWords-1;i++){
        if(!cbptJSON[word] || !cbptJSON[word].transitions) break;
        const possibleNextWords = Object.keys(cbptJSON).filter(
            w => cbptJSON[word].valid_next.includes(cbptJSON[w].part_of_speech)
        );
        if(possibleNextWords.length === 0) break;
        const next = possibleNextWords[Math.floor(Math.random()*possibleNextWords.length)];
        sentence.push(next);
        word = next;
    }
    return sentence.join(" ");
}

function generateCBPT2(start="", maxWords=15){
    const n = models["CBPT-2"].ngrams;
    const ngramsObj = buildNgramsFromJSON(models["CBPT-2"].js, n);
    const tokens = start.split(" ");
    let sentence = [...tokens];
    for(let i=0;i<maxWords;i++){
        const key = sentence.slice(-n).join(" ");
        const possibilities = ngramsObj[key] || [];
        if(possibilities.length === 0) break;
        const next = possibilities[Math.floor(Math.random()*possibilities.length)];
        sentence.push(next);
    }
    return sentence.join(" ");
}

function generateFromCorpusModel(model, start="", maxWords=50){
    const corpora = Array.isArray(model.english) ? model.english : [model.english];
    const corpus = corpora[Math.floor(Math.random()*corpora.length)];
    const n = model.ngrams;
    const tokens = corpus.match(/\b[\w'()-]+\b|[.,!?;]/g) || [];
    const ngrams = {};
    for(let i=0;i<=tokens.length-n;i++){
        const key = tokens.slice(i,i+n).join(" ");
        const next = tokens[i+n];
        if(!ngrams[key]) ngrams[key] = [];
        if(next) ngrams[key].push(next);
    }

    let sentence = start ? start.split(" ") : tokens.slice(0,n);
    for(let i=0;i<maxWords;i++){
        const key = sentence.slice(-n).join(" ");
        const possibilities = ngrams[key] || [];
        if(possibilities.length === 0) break;
        const next = possibilities[Math.floor(Math.random()*possibilities.length)];
        sentence.push(next);
    }
    return sentence.join(" ");
}

function generateMessage(start="", maxWords=50){
    const model = models[selectedModel];
    if(model.english) return generateFromCorpusModel(model, start, maxWords);
    if(selectedModel === "CBPT-1") return generateCBPT1(start, maxWords);
    return generateCBPT2(start, maxWords);
}

// ===== Sending Messages =====
function sendMessage(){
    const userMsg = document.getElementById("user-message").value.trim();
    if(!userMsg) return;
    userMessages.push(userMsg);
    document.getElementById("user-message").value = "";
    setTimeout(()=>{
        const aiResp = generateMessage(userMsg);
        generatedMessages.push(aiResp);
        displayMessages();
    },150);
}

function displayMessages(){
    const list=document.getElementById("messageList");
    list.innerHTML="";
    for(const m of userMessages){
        const li=document.createElement("li");
        li.textContent = m;
        li.className = "message-item user-message";
        list.appendChild(li);
    }
    for(const m of generatedMessages){
        const li=document.createElement("li");
        li.textContent = m;
        li.className = "message-item ai-message";
        list.appendChild(li);
    }
    list.scrollTop = list.scrollHeight;
}

// ===== Toggle Settings Modal =====
function toggleSettings(){
    const modal = document.getElementById("settingsModal");
    modal.style.display = modal.style.display==="flex"?"none":"flex";
}

// ===== Init =====
window.onload = ()=>{
    populateModelSelector();
    loadCBPTJSON();
}
</script>


</body>
</html>

